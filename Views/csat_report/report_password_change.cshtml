
@{
    ViewData["Title"] = "report_password_change";
    Layout = "~/Views/Shared/ownyit_main_page.cshtml";
}
<!--date-time picker-->
<script type="text/javascript">
    var startdate = "";
    var enddate = "";
    $(function () {
        $('input[name="datefilter"]').daterangepicker({
            // opens: 'left',
            autoUpdateInput: true,
            startDate: moment().startOf('hour').add(-24, 'hour'),
            endDate: moment().startOf('hour'),
            locale: {
                format: 'DD/MM/YYYY',
                cancelLabel: 'Clear',

            }
        });

        $('input[name="datefilter"]').on('apply.daterangepicker', function (ev, picker) {
            startdate = picker.startDate.format('DD/MM/YYYY');
            enddate = picker.endDate.format('DD/MM/YYYY');
            $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY '));
        });

        $('input[name="datefilter"]').on('cancel.daterangepicker', function (ev, picker) {
            $(this).val('');
        });
        $(window).bind('scroll', function () {
            $(".daterangepicker").hide();
        });

    });
</script>

<div class="row">

    <div class="ibox float-e-margins ">
        <div class="ibox-content" style="padding:4px;">
            <ul class="breadcrumb" style="margin-bottom:0px;">
                <li>
                    @Html.ActionLink("Reports", "report_agent_information", "csat_report")
                    <i class="icon-angle-right"></i>
                </li>
                <li> Password Change Details </li>
            </ul>
        </div>
    </div>

    <!--side menu-->
    <div class="col-sm-2 col-md-2 col-lg-2 no_padding">
        <div class="ibox float-e-margins ">
            <div class="ibox-content sidemenu">
                @{
                    @Html.Partial("csat_report_menu");
                }
            </div>
        </div>
    </div>
    <!--side menu end-->

    <div class="col-sm-10 col-md-10 col-lg-10">
        <div class="ibox float-e-margins" style="margin-bottom: 10px;">
            <div class="ibox-content">
                <div class="row">
                    <div class="col-sm-12 col-md-12 col-lg-12">

                        <div class="row">
                            <div class="col-xs-12">
                                <form class="form-horizontal" method="post">
                                    <div class="form-group">
                                        <label for="nameField" style="margin-top: -5px;background-color: #fff;text-align: center;color: #3D93C8;width: 120px;" class="col-xs-2 form_label">&nbsp;&nbsp;Advance Search&nbsp;&nbsp;</label>
                                        <div class="col-xs-10">
                                        </div>
                                    </div>

                                </form>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="row">
                    <div class="col-xs-12">
                        <form class="form-horizontal" method="post" name="frm_passwordchg_report" id="frm_passwordchg_report">
                            <div class="form-group">
                                <label for="nameField" class="col-xs-1 form_label">Branch/ Unit</label>
                                <div class="col-xs-3">
                                    <select class="form-control col-sm-3 col-lg-3 col-md-3" name="Branch/ Unit" id="DrpOU"></select>
                                </div>
                                <label for="nameField" class="col-xs-1 form_label ">System Name</label>
                                <div class="col-xs-2" id="selectsys">
                                    <select class="form-control col-sm-3 col-lg-3 col-md-3" name="Device" id="Device">
                                        <option value="-1">Select System Name</option>

                                    </select>
                                </div>
                                <div class="col-xs-2" id="inputsystemname">
                                    <input type="text" class="form-control col-sm-3 col-lg-3 col-md-3" name="add_systemname" id="add_systemname">
                                </div>
                                <div class="col-xs-1">
                                    <input type="checkbox" class="form-check-input" id="add_system_chk" name="add_system_chk" style="width:20px;height:25px;">
                                </div>
                                <label for="nameField" class="col-xs-1 form_label" style="margin-left:-52px;">IP Address</label>
                                <div class="col-xs-2">
                                    <input type="text" class="form-control col-sm-3 col-lg-3 col-md-3" placeholder="" name="ip" id="ip">
                                    @*<select class="form-control col-sm-3 col-lg-3 col-md-3" name="ip" id="ip">
                                            <option value="-1">Select IP Address</option>

                                        </select>*@
                                </div>
                                <div class="pull-left col-xs-1">
                                    <input type="button" class="btn btn-primary" style="display:none" value="Show" id="btnpwdrpt">
                                </div>
                            </div>
                            <div class="form-group">


                            </div>
                        </form>

                    </div>
                </div>
            </div>

        </div>

        <!--form  content end-->
        <!--Password Change Details  form end-->
        <!--Password Change Details Datatable start-->
        <div class="row ibox2">
            <div class="col-sm-12 col-md-12 col-lg-12 ibox2-content" id="tblpwdchange_div">
                <table id="tblpwdchange" class="table table-striped table-bordered display nowrap" width="100%"></table>
            </div>
        </div>

        <!--Password Change Details end-->
    </div>
    <div class="space_bottom">&nbsp;</div>

</div>
<script>
    $(document).ready(function () {
        validateSingleForm("#frm_passwordchg_report");
    });
</script>
<script>
    $.get('@Url.Content("~/csat_report/GetOU/")', null, DataBind)
    function DataBind(data) {
        $("#overlay").show();
        $("#overlay").fadeIn(300);
        //debugger;
        var url = '@Url.Content("~/csat_report/GetOU/")';
        $.ajax({
            type: "POST",
            url: url,
            success: function (data) {
        var SetData = $('#DrpOU');
        jQuery('#DrpOU').html('');
        var oudata = "<option value='-1'>Select Branch/ Unit</option>";
        for (var i = 0; i < data.ou.length; i++) {
            oudata += "<option value='" + data.ou[i].ouid + "'>" + data.ou[i].ouname + "</option>";
        }
                SetData.append(oudata);
            }
        }).done(function () {
            setTimeout(function () {
                $("#overlay").fadeOut(300);
            }, 500);
        });
    }
</script>
<script>
var ouidvalue="";
var systemvalue="";
    var ipvalue = "";
    var actionvalue = "";

$("#DrpOU").change(function () {

     //  debugger;
        ouidvalue = this.value;
        var url = '@Url.Content("~/csat_report/Get_syatemname_ip?ouid=")' + this.value;
        $.ajax({
            type: "POST",
            url: url,
            success: function (data) {
			//debugger;
                var SetDatadevice = $('#Device');
				 //var SetDataip = $('#ip');
                jQuery('#Device').html('');
                //jQuery('#ip').html('');

		  //var devicedata = "<option value='-1'>Select System Name</option>";
                var devicedata ;
		 //var ipdata = "<option value='-1'>Select IP Address</option>";
      	    for (var i = 0; i < data.systemip.length; i++) {
                    devicedata += "<option value='" + data.systemip[i].device_id +"'>"+ data.systemip[i].device_name +"</option>";
                    //ipdata+="<option value='"+ data.systemip[i].ip +"'>"+ data.systemip[i].ip +"</option>";
											}
                SetDatadevice.append(devicedata);
				//SetDataip.append(ipdata);
                if (data.systemip.length > 0)
                    document.getElementById('btnpwdrpt').style.display = "block";
                else
                    document.getElementById('btnpwdrpt').style.display = "none";
            }

            });

    });


    $("#Device").change(function () {
        systemvalue = this.value;
    });
    //$("#ip").change(function () {
    //    ipvalue = this.value;
    //    //systemvalue= this.value;

    //});
    var type = "";
    $("#type").change(function () {
        //debugger;
        type = this.value;
    });

    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function replaceAll(str, term, replacement) {
        return str.replace(new RegExp(escapeRegExp(term), 'g'), replacement);
    }

    $('#btnpwdrpt').on('click', function () {
        var $valid = $('#frm_passwordchg_report').valid();
        if (!$valid) {
            $validatorform.focusInvalid();
            return false;
        } else {
            var ipvalue = document.getElementById('ip').value;
            startdate = "";
            enddate = "";
            //alert(systemvalue);
            //if (systemvalue == null || systemvalue.length <= 0) {
            //    systemvalue = document.getElementById('Device').value;
            //}
            var systemvalue = document.getElementById('add_systemname').value;
            if (systemvalue == "") {
                systemvalue = document.getElementById("Device").value;
            }
           // alert(systemvalue);
            $("#overlay").show();
            $("#overlay").fadeIn(300);
            var url = '@Url.Content("~/csat_report/GetpasswordchangeReport?IP=")' + ipvalue + '&Device=' + systemvalue + '&ouid=' + ouidvalue + '&startdate=' + startdate + '&enddate=' + enddate + '&usertype=' + type;
            $.ajax({
                type: "POST",
                url: url,
                success: function (data) {
                    var dataclear = document.getElementById('tblpwdchange_div');
                    dataclear.innerHTML = '&nbsp;';
                    $('#tblpwdchange_div').append("<table id='tblpwdchange' class='table table-striped table-bordered' width='100%'></table>");
                    otable = document.getElementById('tblpwdchange');
                    var data1 = [];
                    var months_arr = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
                    for (var i = 0; i < data.userpasswordchangedata.length; i++) {

                        var unixtimestamp = "";
                        var userpassword = "";
                        var convdataTime = "NA";
                        try {
                            userpassword = data.userpasswordchangedata[i].json;
                            //alert(userpassword);
                            var userpassworddata = replaceAll(userpassword, '//', '/');
                            userpassworddata = replaceAll(userpassworddata, '/`', '"');
                            var changepassworddata = "";
                            changepassworddata = JSON.parse(userpassworddata);
                            unixtimestamp = changepassworddata.PasswordLastSet;
                            var date = new Date(unixtimestamp * 1000);
                            var year = date.getFullYear();
                            var month = months_arr[date.getMonth()];
                            var day = date.getDate();
                            var hours = date.getHours();
                            var minutes = "0" + date.getMinutes();
                            var seconds = "0" + date.getSeconds();
                            convdataTime = day + '-' + month + '-' + year + ' ' + hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
                            //var passworddate = convdataTime;
                        } catch (e) {
                            convdataTime = "NA";
                            //alert(e);
                            //alert(userpassword);
                        }
                        //alert(convdataTime);
                        if (convdataTime == "" || convdataTime.length <= 0 || convdataTime == 'NaN-undefined-NaN NaN:aN:aN')
                            convdataTime = "NA";
                        var passworddate = convdataTime;

                        if (passworddate == 'NaN-undefined-NaN NaN:aN:aN')
                            passworddate = '';
                        if (data.userpasswordchangedata[i].username == 'NA')
                            data.userpasswordchangedata[i].username = '';
                        data1.push([data.userpasswordchangedata[i].ou_longname, data.userpasswordchangedata[i].device_name, data.userpasswordchangedata[i].ip, data.userpasswordchangedata[i].username, passworddate]);
                        //data1.push([data.userpasswordchangedata[i].ou_longname, data.userpasswordchangedata[i].device_name, data.userpasswordchangedata[i].ip, data.userpasswordchangedata[i].username, data.userpasswordchangedata[i].json]);
                    }

                    var otable = $("#tblpwdchange").DataTable({
                        data: data1, scrollX: !0, searching: !1, dom: "<'top'lB>rt<'bottom'ip><'clear'>", buttons: ["colvis", { text: "PDF", extend: "pdfHtml5", download: "open", filename: "Password Change Details_" + today, orientation: "portrait", pageSize: "A4", exportOptions: { columns: ":visible", search: "applied", order: "applied" }, customize: function (t) { t.content.splice(0, 1); var e = new Date, n = e.getDate() + "-" + (e.getMonth() + 1) + "-" + e.getFullYear(); t.pageMargins = [20, 60, 20, 30], t.defaultStyle.fontSize = 7, t.styles.tableHeader.fontSize = 7, t.header = function () { return { columns: [{ margin: [0, -5, 30, 15], alignment: "left", width: 100, image: "data:image/png;base64," + pdflogo }, { margin: [-10, 10, 10, 0], alignment: "center", width: 410, text: "Password Change Details Report", fontSize: 12 }, { alignment: "right", fontSize: 14, text: "" }], margin: 20 } }, t.footer = function (t, e) { return { columns: [{ alignment: "left", text: ["Created on: ", { text: n.toString() }] }, { alignment: "right", text: ["page ", { text: t.toString() }, " of ", { text: e.toString() }] }], margin: 20 } }; var a = { hLineWidth: function (t) { return .5 }, vLineWidth: function (t) { return .5 }, hLineColor: function (t) { return "#aaa" }, vLineColor: function (t) { return "#aaa" }, paddingLeft: function (t) { return 4 }, paddingRight: function (t) { return 4 } }; t.content[0].layout = a } }, 'excel'],
                        columns: [{ title: "Branch/ Unit" }, { title: "System Name" }, { title: "IP Address" }, { title: "Username" }, { title: "Password change On" }]
                    });
                    $(".table").css({ "width": "100%" });
                    $(".dataTables_scrollHeadInner ").css({ "width": "100%" });
                }
            }).done(function () {
                setTimeout(function () {
                    $("#overlay").fadeOut(300);
                }, 500);
            });
        }
    });
</script>
<script>
    //checkbox input hide & show
    $('#inputsystemname').hide();
    $('#add_system_chk').on('click', function () {
        if ($(this).is(':checked')) {
            $('#selectsys').hide();
            $('#inputsystemname').show();
        }
        else {
            $('#selectsys').show();
            $('#inputsystemname').hide();
            document.getElementById('add_systemname').value = "";
        }
    });
</script>
